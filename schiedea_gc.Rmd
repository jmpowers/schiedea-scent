---
title: "*Schiedea* scent evolution"
author: "[John Powers](http://sites.uci.edu/powers/)"
date: "`r Sys.Date()`"
output:
  html_document:
  self_contained: no
lib_dir: libs
code_folding: hide
toc: yes
toc_float: TRUE
editor_options: 
  chunk_output_type: console
---
  
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>
  
```{r setup, message=FALSE}
library(tidyverse)
library(vegan)
library(knitr)
library(reshape2)
library(viridis)
knitr::opts_chunk$set(comment="", cache=T, warning = F, message = F, 
                      fig.path = "images/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)
options(digits=4) # for kables
source("read_shimadzu.R")
```

```{r read_scents}
# sch.data <- read.shimadzu("../Schiedea/schiedea190801.txt")
# sch.data2 <- read.shimadzu("../Schiedea/Schiedea_190814.txt")
# sch.data <- bind_rows(sch.data, sch.data2)
# save(sch.data, file="data/schiedea_190801_190814.Rdata")
# sch.data.212223 <- "../RMBL Batches/" %>% paste0(list.files(., pattern="txt")) %>%
#   set_names() %>% map_dfr(read.shimadzu, .id="batch") %>% mutate(batch = str_remove(batch, "../RMBL Batches/"))
# save(sch.data.212223, file="data/schiedea_212223.Rdata")
load("data/schiedea_190801_190814.Rdata")
load("data/schiedea_212223.Rdata")
sch.data.212223 %>% count(batch, Filename) %>% filter(str_detect(Filename, "SCH"))
sch.data <- bind_rows(sch.data, sch.data.212223)

sch.all <- dcast(sch.data, Filename~Name, sum, value.var="Area")
rownames(sch.all) <- sch.all[,1]
sch.all[,1] <- NULL
sch.cut <- sch.all[,colSums(sch.all)>4e6]
```


```{r kmeans}
set.seed(1)
km <- kmeans(decostand(sch.cut, "log"), centers=30, nstart=3)
isblank <- grepl("Blank|Bakeout", rownames(sch.cut))#if original FileName says blank
table(km$cluster, isblank)
kblank <- km$cluster == which.max(table(km$cluster, isblank)[,2])

#load("../Inventory/markes_sequence.rda") #from markes_sequence.R
#save(sequ.summary, file="data/sequ_summary.rda")
load("data/sequ_summary.rda")
Powers <- grepl("Powers RMBL Data", sequ.summary$FullName, fixed=T) | grepl("SCH_", sequ.summary$FileName, fixed=T)
schiedea.ids <- sequ.summary %>% filter(Powers) %>% select(id) %>% unique %>% na.omit
schgc <- sequ.summary %>% filter(id %in% schiedea.ids$id | Powers)
schgc$vial <- as.integer(str_match(schgc$FileName, "_V(\\d{1,3})")[,2])
schgc$dupe <- !is.na(schgc$vial) & schgc$vial %in% schgc$vial[duplicated(schgc$vial)]
sch.km <- data.frame(FileName=row.names(sch.cut), 
                     nameBlank= isblank, Mixup= isblank!=kblank, kBlank=kblank,
                     Cluster=km$cluster)[match(schgc$FileName, row.names(sch.cut)),]
schgc <- cbind(schgc, sch.km[,-1])
rownames(schgc) <- 1:nrow(schgc)

notebook <- read.delim("data/leak_notebook.csv")
schgc <- cbind(schgc, notebook[match(schgc$vial, as.integer(as.character(notebook$Vial)), incomparables=NA),-4])
schgc$TubeMatch <- schgc$Tube == schgc$SteelTube
write.csv(schgc, "data/schiedea_all220806.csv")

with(sch.km, table(kBlank, nameBlank))
```

```{r kmeans_pca}
pca.sch.cut <- rda(sqrt(sch.cut))
ordiplot(pca.sch.cut, type = "n")
text(pca.sch.cut, display="sites", labels=km$cluster, col=kblank+1,cex=0.5 )
points(pca.sch.cut, display="sites", col=ifelse(kblank, "black", rainbow(k)[km$cluster]), pch=as.integer(isblank)+1)
```

```{r schgc}
#match up with metadata
#sampl <-gs_title("Schiedea Volatiles Sampling")
#sampl <- "1DhjN1O3tvAwG1NnCp9oUSEVxoNKgQyperArin2zbsFY"
sampl <- "data/Schiedea Volatiles Sampling - Samples.tsv"
s <- read_tsv(sampl, col_types = cols(.default = col_character(),
                                     Flow = col_double(),
                                     Mass = col_double(),
                                     RunDate = col_date(format = ""),
                                     SampleDate = col_date(format = ""),
                                     Start = col_time(format = ""),
                                     Stop = col_time(format = ""),
                                     Equi = col_double(),
                                     Duration = col_double(),
                                     Total = col_double()
))
s.nr <- s[s$GC=="NR",]
s.nr$Vial <- as.integer(s.nr$Vial)
sort(union(s.nr$Vial, schgc$vial2))
sort(setdiff(s.nr$Vial, schgc$vial2)) #not run yet
sort(setdiff(schgc$vial2, s.nr$Vial)) #run but not entered  
broken <- c(52,53,56,86,117,124,125,129,174) #broken traps - not run
empty <- c(7,16,18,28,40,313,314,315,316) # presumed clean - run
notrun <- c(5,8,21,30,33,50,51,55,57,64,66,74,75,80,81,82,83,84,88,89,91,95,100,102,103,104,107,108,109,11,12,22,23,24,25,26,58,59,60,61,62,63,58,92,94,96,97,98,9, 90, 79, 87, 72, 99)
setdiff(setdiff(setdiff(s.nr$Vial, schgc$vial2), broken), notrun)
s.nr$DN <- factor(ifelse(s.nr$Start > 16*60*60, "Night", "Day"))
#s.nr$FileName <- schgc$FileName2[match(s.nr$Vial, schgc$vial2)]

#read back the verdicts
#library(googlesheets4)
#rmbl <- gs_title("Schiedea RMBL GC-MS Inventory")
#schgc.verdict <- read_sheet("1_rNiQ3IwKIKQhfxZTBJbKU14ed6L1rGQpe7e_ttJl6Y", na="NA", guess_max=2000)
schgc.verdict19 <- read_tsv("data/Schiedea RMBL GC-MS Inventory - schiedea_all.tsv") %>% 
  mutate(across(all_of(c("sequence.start", "Desorb.Start.Time", "CreationTime", "eithertime")), ymd_hms),
         create_desorb = duration(create_desorb),
         ApproxDate = as.character(ApproxDate)) %>% 
  filter(index <= 841) #knock off a couple blanks that don't align
schgc.verdict2122 <- schgc[106:142,] %>% #842:891
  left_join(s.nr %>% select(vial3=Vial,FileName=Filename) %>%  filter(vial3 >=700))  #TODO hack to paste in the new samples
schgc.verdict <- bind_rows(schgc.verdict19, schgc.verdict2122)
#TODO add 2023 (31 or 33 rows)
#sum(schgc.verdict$FileName != schgc$FileName, na.rm=T)
schgc$verdict <- schgc.verdict$verdict
schgc$FileName2 <- ifelse(is.na(schgc.verdict$sample), schgc$FileName, schgc.verdict$sample)
schgc$vial2 <- as.integer(str_match(schgc$FileName2, "_V(\\d{1,3})")[,2])
schgc$vial2 <- coalesce(schgc$vial2, schgc.verdict$vial3)#TODO hack for new samples
schgc$dupe2 <- !is.na(schgc$vial2) & schgc$vial2 %in% schgc$vial2[duplicated(schgc$vial2)]
#schgc.use <- schgc[!(schgc$verdict %in% c("alreadyrun", "empty","leak-blank", "notmine", "notrun", "skip-blank", "skip-notrun")),]

sv.all <- merge(s.nr, schgc, by.x = "Vial", by.y="vial2", all.x = T, all.y = T)
write.csv(sv.all, "s.nr.schgc220806.csv")
```

